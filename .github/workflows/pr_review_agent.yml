name: PR Review Agent

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  review:
    # ignora PR em draft (opcional, mas recomendado)
    if: github.event.pull_request.draft == false

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Send PR to Review API
        env:
          REVIEW_API_URL: ${{ secrets.REVIEW_API_URL }}
          REVIEW_API_KEY: ${{ secrets.REVIEW_API_KEY }}
          GH_TOKEN: ${{ github.token }}

          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}

        run: |
          echo "Sending PR #$PR_NUMBER for review..."

          curl -sS -X POST "$REVIEW_API_URL/api/v1/reviews/pr/run" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $REVIEW_API_KEY" \
            -H "X-GitHub-Token: $GH_TOKEN" \
            -d "{
              \"repo_full_name\": \"$REPO\",
              \"pr_number\": $PR_NUMBER,
              \"head_sha\": \"$HEAD_SHA\",
              \"base_sha\": \"$BASE_SHA\"
            }"
